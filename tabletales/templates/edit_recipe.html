{% extends "base.html" %}
{% load static %}
{% block content %}
<h1>Edit Recipe: {{ recipe.title }}</h1>

<a href="{% url 'delete_recipe' recipe.pk %}?from={{ back_url }}" class="delete-btn">
  üóëÔ∏è Delete Recipe
</a>

<form method="post" enctype="multipart/form-data" id="recipe-form">
  {% csrf_token %}

  <fieldset>
    <legend>Recipe Info</legend>
    {{ form.as_p }}
  </fieldset>

  <fieldset id="ingredient-section">
    <legend>Ingredients</legend>

    {{ formset.management_form }}

    {% if form.errors %}
    <div style="color:red;">
        <strong>Recipe Form Errors:</strong> {{ form.errors }}
    </div>
    {% endif %}
    
    {% for f in formset %}
      {% if f.errors %}
        <div style="color:red;">
            <strong>Ingredient Form Errors:</strong> {{ f.errors }}
        </div>
      {% endif %}
    {% endfor %}
    
    {% if formset.non_form_errors %}
    <div style="color:red;">
        <strong>Formset Errors:</strong> {{ formset.non_form_errors }}
    </div>
    {% endif %}


    <!-- Hidden empty form template for JS cloning -->
    <div id="empty-form" style="display:none;">
      <div class="ingredient-form">
        {{ formset.empty_form.name.label_tag }} {{ formset.empty_form.name }}
        {{ formset.empty_form.quantity.label_tag }} {{ formset.empty_form.quantity }}

        <!-- Hidden DELETE field -->
        <span style="display:none;">
          {{ formset.empty_form.DELETE }}
        </span>

        <button type="button" class="remove-ingredient">Remove</button>
      </div>
    </div>

    <!-- Ingredient forms wrapper -->
    <div id="ingredient-forms">
      {% for form in formset %}
        <div class="ingredient-form">

           {{ form.id }}

          {{ form.name.label_tag }} {{ form.name }}
          {{ form.quantity.label_tag }} {{ form.quantity }}

          {% if form.instance.pk %}
            <!-- Hidden DELETE checkbox for existing ingredients -->
            <span style="display:none;">
              {{ form.DELETE }}
            </span>
          {% endif %}

          <button type="button" class="remove-ingredient">Remove</button>
        </div>
      {% endfor %}
    </div>

    <button type="button" id="add-ingredient">+ Add Ingredient</button>
  </fieldset>

  <button type="submit" class="submit-btn">Save Changes</button>
</form>

<link rel="stylesheet" href="{% static 'css/edit_recipe.css' %}">
<script src="{% static 'js/edit_recipe.js' %}"></script>
{% endblock %}
