{% extends "base.html" %}
{% block content %}

<div class="detail-buttons">
    <a href="{{ back_url }}" class="btn back-btn">â¬… Back</a>

    {% if user == recipe.author or user.is_staff or user.is_superuser %}
        <a href="{% url 'edit_recipe' recipe.pk %}?from={{ back_url }}" class="btn edit-btn">âœï¸ Edit</a>
    {% endif %}
</div>



<h1>{{ recipe.title }}</h1>
<p><em>by {{ recipe.author.username }}</em></p>

<!-- Favorite Button -->
<form action="{% url 'toggle_favorite' recipe.pk %}" method="post" style="display:inline;">
    {% csrf_token %}
    {% if user.is_authenticated %}
        <button type="submit" style="border:none; background:none; cursor:pointer; font-size:24px;">
            {% if user in recipe.favorited_by.all %}
                â¤ï¸ <!-- filled heart if already favorited -->
            {% else %}
                ğŸ¤ <!-- empty heart if not favorited -->
            {% endif %}
        </button>
    {% else %}
        <a href="{% url 'login' %}">Log in to favorite</a>
    {% endif %}
</form>

<h3>Ingredients</h3>
<table>
  {% for ingredient in recipe.ingredients.all %}
  <tr>
    <td>â€¢ {{ ingredient.name }}</td>
    <td style="padding-left: 15px;">{{ ingredient.quantity }}</td>
  </tr>
  {% endfor %}
</table>

<h3>Instructions</h3>
<ol>
  {% for step in recipe.get_instruction_steps %}
    <li>{{ step }}</li>
  {% endfor %}
</ol>

<!-- Comments Section -->
<h3>Comments</h3>

<!-- Comment form FIRST -->
{% if user.is_authenticated %}
  <form method="post" class="comment-form" style="margin-bottom:20px;">
    {% csrf_token %}
    <textarea name="text" rows="3" placeholder="Add your comment..." required style="width:100%;"></textarea><br>
    <button type="submit">Post Comment</button>
  </form>
{% else %}
  <p><a href="{% url 'login' %}">Log in</a> to post a comment.</p>
{% endif %}

<hr>

<!-- Existing comments -->
<div class="comments-section">
  {% for comment in comments %}
    <div class="comment" style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #ddd;">
      <strong>{{ comment.user.username }}</strong>
      <p>{{ comment.text }}</p>
      <small>{{ comment.created_on|date:"jS F Y, g:i a" }}</small>

      {% if user == comment.user or user.is_staff or user.is_superuser %}
        <div class="comment-actions" style="margin-top: 5px;">
          <a href="{% url 'edit_comment' comment.id %}" style="color: blue; text-decoration: none;">âœï¸ Edit</a> |
          <a href="{% url 'delete_comment' comment.id %}" style="color: red; text-decoration: none;"
             onclick="return confirm('Are you sure you want to delete this comment?');">ğŸ—‘ï¸ Delete</a>
        </div>
      {% endif %}
    </div>
  {% empty %}
    <p>No comments yet. Be the first to comment!</p>
  {% endfor %}
</div>

{% endblock %}